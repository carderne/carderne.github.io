<!DOCTYPE html>
<html>
	<head>
            <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
	    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
	    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	    <title>Modelling hydrological networks at huge scale</title>
	    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,700italic,300,700" rel="stylesheet" type="text/css">
			<link href="https://fonts.googleapis.com/css?family=Bree+Serif" rel="stylesheet" type="text/css">

			<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
			<link rel="stylesheet" type="text/css" href="../assets/styles/crisp.css?v=9508c7300d">
	    <meta name="HandheldFriendly" content="True">
	    <meta name="viewport" content="width=device-width, initial-scale=1.0">
			<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
			<!--[if lt IE 9]>
				<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
				<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
			<![endif]-->
			
	    <link rel="shortcut icon" href="../favicon.png" type="image/png">
    <link rel="canonical" href="/modelling-hydrological-networks/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta property="og:site_name" content="Chris Arderne">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Modelling hydrological networks at huge scale">
    <meta property="og:description" content="Ironically, a large part of my work at KTH's Division of Energy Systems Analysis was modelling complex hydrological systems. Often, this was while modelling the 'nexus' between different systems, such as energy, water and climate – as opposed to treating these as separate fields of study.A lot of this was">
    <meta property="og:url" content="/modelling-hydrological-networks/">
    <meta property="article:published_time" content="2017-04-15T13:26:00.000Z">
    <meta property="article:modified_time" content="2018-10-26T12:36:59.000Z">
    <meta property="article:tag" content="Inside">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Modelling hydrological networks at huge scale">
    <meta name="twitter:description" content="Ironically, a large part of my work at KTH's Division of Energy Systems Analysis was modelling complex hydrological systems. Often, this was while modelling the 'nexus' between different systems, such as energy, water and climate – as opposed to treating these as separate fields of study.A lot of this was">
    <meta name="twitter:url" content="/modelling-hydrological-networks/">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="Chris Arderne">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="Inside">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Chris Arderne",
        "logo": {
            "@type": "ImageObject",
            "url": "/content/images/2018/10/face3.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Chris Arderne",
        "url": "/author/chris/",
        "sameAs": []
    },
    "headline": "Modelling hydrological networks at huge scale",
    "url": "/modelling-hydrological-networks/",
    "datePublished": "2017-04-15T13:26:00.000Z",
    "dateModified": "2018-10-26T12:36:59.000Z",
    "keywords": "Inside",
    "description": "Ironically, a large part of my work at KTH&#x27;s Division of Energy Systems Analysis was modelling complex hydrological systems. Often, this was while modelling the &#x27;nexus&#x27; between different systems, such as energy, water and climate – as opposed to treating these as separate fields of study.A lot of this was",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "/"
    }
}
    </script>

    <script src="../public/ghost-sdk.min.js?v=9508c7300d"></script>
<script>
ghost.init({
	clientId: "ghost-frontend",
	clientSecret: "ffd2c8ae15fe"
});
</script>
    <meta name="generator" content="Ghost 2.2">
    <link rel="alternate" type="application/rss+xml" title="Chris Arderne" href="/rss/">
	</head>
	<body class="post-template tag-inside">
		<header id="header">
			<a id="logo" href="https://rdrn.me"><img src="../content/images/2018/10/face3.png" alt="Chris Arderne"></a>
			<h1><a href="https://rdrn.me">Chris Arderne</a></h1>
                        
			<div id="icons">
<a href="mailto:chris@rdrn.me"><i class="fa fa-envelope-square"></i></a>
<a href="https://www.linkedin.com/in/chris-arderne" target="_blank"><i class="fa fa-linkedin-square"></i></a>
<a href="https://github.com/carderne" target="_blank"><i class="fa fa-github-square"></i></a>
</div> 
			  <div id="internal_link"><h5><a href="/">Home</a></h5></div>
  <div id="internal_link"><h5><a href="/about/">About me</a></h5></div>

                        <p>A blog for adventurous trip reports, explorations of data and code, and sometimes even things from my day job. Use the links above to learn more, see my work and get in touch.</p>
		</header>
		<main id="content"> 
			<article id="5bbc65567cc70a140e7fd126" class="post tag-inside">
	<div class="post-stamp">15 April 2017<span class="taglist"> · <a href="../tag/inside/">Inside</a></span></div>
	<h1 class="post-title">Modelling hydrological networks at huge scale</h1>
	<p>Ironically, a large part of my work at KTH's <a href="https://www.kth.se/en/itm/inst/energiteknik/forskning/desa/welcome-to-the-unit-of-energy-systems-analysis-kth-desa-1.197296">Division of Energy Systems Analysis</a> was modelling complex hydrological systems. Often, this was while modelling the 'nexus' between different systems, such as energy, water and climate – as opposed to treating these as separate fields of study.</p><p>A lot of this was done in <a href="https://www.weap21.org/index.asp?NewLang=EN">WEAP</a>, a hydrological modelling package courtesy of the <a href="https://www.sei.org/">Stockholm Environmental Institute</a><a>.</a> This provided an easy user interface, and access to a variety of complex models and systems for things such as rainwater runoff and crop requirements. However, it isn't easily scriptable, and is mostly suited to very localised systems.</p><p>So when my colleagues and I wanted to conduct a continent-scale assessment of mini-hydropower potential, we had to turn elsewhere. For the first version of this, I created a simple script to run down every river in a given network and calculate the elevation drop (head) between points to estimate hydropower potential. We applied this to the whole of Sub-Saharan Africa, using river networks from <a href="https://www.hydrosheds.org/">HydroSHEDS</a> and run-off data from the EU's <a href="https://data.jrc.ec.europa.eu/collection/water">Joint Research Centre</a>. The paper we wrote for this is currently under review with the journal <a href="https://www.mdpi.com/journal/energies">Energies</a>.</p><p>Later on, I decided to improve and generalise this simple model and came with an unwieldy bit of code called <a href="https://github.com/carderne/hydro-networks">hydro-networks</a>. Instead of just creating points all over the show, I set out to create a model that would:</p><ul><li>Conduct massive scale hydrological modelling</li><li>Calculate run-off and streamflow using precipitation and land-use data</li><li>Model rivers in a network-aware manner</li><li>Allow point sources/drains such as farms and dams to be added procedurally</li></ul><p>At a rough estimate, I achieved about 3/4 of this, and realised run-off modelling is damn hard. What I did manage was still pretty fun, so I'm going to go over an example below, in the hopes that one day I'll pick this up again and complete it.</p><h3 id="create-direction-aware-river-networks">Create direction-aware river networks</h3><p>The model uses the wonderful <a href="https://geopandas.org/">GeoPandas</a> library to read in the river network data from <a href="https://www.hydrosheds.org/">HydroSHEDS</a>. It is very happy with the data for the whole African continent, but to make this easier, I've clipped out a small river called <em>Dieprivier</em> just outside Cape Town (yes, they exist).</p><figure class="kg-card kg-image-card"><img src="../content/images/2018/10/riv_start-1.png" class="kg-image"></figure><p>If we zoom into a small section we see the the model-generated layer (purple) matches pretty well with the painstakingly traced layer (light blue) from OpenStreetMap!</p><figure class="kg-card kg-image-card"><img src="../content/images/2018/10/small_section-1.png" class="kg-image"></figure><p>The model then goes through a couple of steps to convert this GIS data into something we can use for modelling.</p><ol><li>Go through every river segment in the input data, and create for it a separate <em>arc</em>, which altogether form the data structure <em>network. </em>Each arc contains its index, start and end coordinates and length.</li><li>As it does this, create another data structure called <em>nodes </em>that contains all of these end points and their coordinates.</li><li>Then tell every <em>arc</em> which two nodes it is connected to, and tell each <em>node </em>which arcs it is connected to (at least one, up to four?). This means if we know a node location, we know which arcs connect to it, and therefore which other nodes are connected, and so on.</li></ol><p>A small section of the resulting layers is shown below, with the nodes at the intersections of river arcs. Now the large green node <em>knows </em>which arcs are connected to it (also in green) and they in turn know about it.</p><figure class="kg-card kg-image-card"><img src="../content/images/2018/10/nodes-1.png" class="kg-image"></figure><h3 id="giving-the-network-some-order">Giving the network some order</h3><p>This is all very well, but it's still just a bunch of lines and dots. To make this network a lot easier to use, we must assign <a href="https://en.wikipedia.org/wiki/Stream_order">stream orders</a> to the arcs – essentially indicating how many upstream branches they have. This is a useful proxy for how 'big' any part of a river is relative to the network, but also allows the model to easily orientate itself to what is up- and down-stream of any node.</p><p>There are two main approaches to this, the <a href="https://en.wikipedia.org/wiki/Strahler_number">Strahler number</a> and the Shreve number. For the Strahler number, the smallest tributaries are assigned an order of 1. These are then followed down, and when two 1's join, they form a 2. If two streams with a different number join, it gets the higher of the two, i.e. 1+2=2. The Shreve number is similar, except the numbers always add, so 1+2=3! For this model, I used the Shreve number, as it ensures that a downstream section always has a higher number that the sections upstream of it.</p><p>To achieve this, I adapted the algorithm from <a href="https://doi.org/10.1111/j.1752-1688.2004.tb01057.x">this paper</a> (Gleyzer, et al., 2007), a beautiful but not very intuitive recursive function. Basically, it starts at the mouth of a given river (identified by a separate bit of code) and then follows recursively up the network until it reaches the mountain-top tributaries. Then it trickles back down to the mouth, adding up the stream orders as it goes.</p><pre><code class="language-Python">def shreve(arc_index, direction_node_id, network, nodes):
    up_stream_orders = []
    if len(nodes[direction_node_id]) == 5:
        network[arc_index][7] = 1
    else:
        for index, arc in enumerate(nodes[direction_node_id]):
            if index &gt;= 4:
                if network[arc][0] != arc_index:
                    if network[arc][5] != direction_node_id:
                        up_stream_orders.append(shreve(arc,
                            network[arc][5], network, nodes))
                    else:
                        up_stream_orders.append(shreve(arc,
                            network[arc][6], network, nodes))
        max_orders = heapq.nlargest(2, up_stream_orders)
        if len(max_orders) == 2:
            order = 0 + max_orders[0] + max_orders[1]
        else:
            order = 0 + max(up_stream_orders)

        network[arc_index][7] = order
    return network[arc_index][7]
</code></pre>
<p>Applied to the entire river network, it looks something like this.</p><figure class="kg-card kg-image-card"><img src="../content/images/2018/10/so_big.png" class="kg-image"></figure><h3 id="adding-data-layers-and-doing-things">Adding data layers and doing things</h3><p>Now that we have the network set up and ordered, it's time to do something with it! In addition to the run-off data mentioned further up, there are a few other important layers:</p><ul><li>Digital elevation model (DEM), normally from <a href="https://www2.jpl.nasa.gov/srtm/">NASA's SRTM</a></li><li>Flow accumulation, which is derived from the DEM and also available at <a href="https://www.hydrosheds.org/">HydroSHEDS</a></li><li>Land cover, used for modelling run-off and available from the <a href="https://www.fao.org/land-water/land/land-governance/land-resources-planning-toolbox/category/details/en/c/1036355/">FAO</a></li><li>ETo, the reference evapotranspiration for an area, also available from the FAO</li><li>Precipitation, from many sources, hopefully monthly, never easy to use</li></ul><p>For example, here's our same river overlaid with the DEM elevation data.</p><figure class="kg-card kg-image-card"><img src="../content/images/2018/10/with_dem-1.png" class="kg-image"></figure><p>Previously I used the laborious and buggy <a href="https://www.arcgis.com/">ArcGIS</a> to extract all of this information in the <em>network </em>and <em>nodes </em>data structures, but now <a href="https://github.com/mapbox/rasterio">rasterio</a> makes this a walk in the park. It's a straightforward library for reading raster GIS data and sampling and manipulating it, and takes only a few lines to load all of this new data.</p><h3 id="calculating-hydropower-potential">Calculating hydropower potential</h3><p>One thing that we can do with all of this data is replicate from the paper we wrote, except now just for Cape Town. Note that this is exclusively for mini-hydropower of run-of-river type, which, used properly, can have negligible impact on river flow.</p><p>The hydropower formula is as follows:</p><ul><li><em>P = ηρgQH</em></li></ul><p>where <em>P</em> is the power output in watts, <em>η</em> is the efficiency, <em>ρ</em> is the density of water, and <em>g </em>is acceleration due to gravity. <em>Q </em>is the flow-rate, and <em>H </em>is the head, or height difference available. These last two must be calculated for each point using the data described above.</p><p>The heigh difference is simple: we get the height for our chosen point, and then look a set distance up-stream and get the height there. The difference between these is the head. The flow-rate is more complicated. The global run-off data is provided in mm/year, where we need m<sup>3</sup>/s. So we do the following:</p><ul><li><em>Q = run-off × up-cells × cell-area</em></li></ul><p>Where <em>run-off </em>is the run-off data we already have. Then <em>up-cells </em>is the value from the flow accumulation area, and indicates how many uniformly-sized grid-cells are upstream of this point, and <em>cell-area </em>is the size of each of these cells. Multiplying these together calculates the theoretical amount of water that should flow past this point.</p><p>Applying this to <em>Dieprivier</em> and filtering to only include those with at least 10 metres of head and more than 100 kW output, we get the following right at the river mouth.</p><figure class="kg-card kg-image-card"><img src="../content/images/2018/10/hydro-1.png" class="kg-image"></figure><h2 id="going-further-with-rainfall-run-off-and-discharge">Going further with rainfall run-off and discharge</h2><p>In progress!</p>
</article>  

		</main>
		<footer id="footer">
			<section id="footer-message">© 2018 Chris Arderne.</section>
		</footer>
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
	</body>
</html>