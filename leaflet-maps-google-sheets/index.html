<!DOCTYPE html>
<html>
	<head>
            <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
	    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
	    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	    <title>Leaflet maps with data from Google Sheets</title>
	    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,700italic,300,700" rel="stylesheet" type="text/css">
			<link href="https://fonts.googleapis.com/css?family=Bree+Serif" rel="stylesheet" type="text/css">

			<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
			<link rel="stylesheet" type="text/css" href="../assets/styles/crisp.css?v=89eb70e2e2">
	    <meta name="HandheldFriendly" content="True">
	    <meta name="viewport" content="width=device-width, initial-scale=1.0">
			<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
			<!--[if lt IE 9]>
				<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
				<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
			<![endif]-->
			
	    <meta name="description" content="In this post I'm going to go through making a web map in JavaScript that pulls data from Google Sheets – where non-coders can easily make updates.">
    <link rel="shortcut icon" href="../favicon.png" type="image/png">
    <link rel="canonical" href="/leaflet-maps-google-sheets/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta property="og:site_name" content="Chris Arderne">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Leaflet maps with data from Google Sheets">
    <meta property="og:description" content="I love working with Python, but as soon as you want to put something online, JavaScript's ability to process in the browser is a clear winner. In this post I'm going to go through making a web map in JavaScript that pulls data from Google Sheets – where non-coders can easily make updates.">
    <meta property="og:url" content="/leaflet-maps-google-sheets/">
    <meta property="article:published_time" content="2018-10-19T17:51:19.000Z">
    <meta property="article:modified_time" content="2018-10-23T14:08:35.000Z">
    <meta property="article:tag" content="Inside">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Leaflet maps with data from Google Sheets">
    <meta name="twitter:description" content="I love working with Python, but as soon as you want to put something online, JavaScript's ability to process in the browser is a clear winner. In this post I'm going to go through making a web map in JavaScript that pulls data from Google Sheets – where non-coders can easily make updates.">
    <meta name="twitter:url" content="/leaflet-maps-google-sheets/">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="Chris Arderne">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="Inside">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Chris Arderne",
        "logo": {
            "@type": "ImageObject",
            "url": "/content/images/2018/10/face3.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Chris Arderne",
        "url": "/author/chris/",
        "sameAs": []
    },
    "headline": "Leaflet maps with data from Google Sheets",
    "url": "/leaflet-maps-google-sheets/",
    "datePublished": "2018-10-19T17:51:19.000Z",
    "dateModified": "2018-10-23T14:08:35.000Z",
    "keywords": "Inside",
    "description": "I love working with Python, but as soon as you want to put something online, JavaScript&#x27;s ability to process in the browser is a clear winner. In this post I&#x27;m going to go through making a web map in JavaScript that pulls data from Google Sheets – where non-coders can easily make updates.",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "/"
    }
}
    </script>

    <script src="../public/ghost-sdk.min.js?v=89eb70e2e2"></script>
<script>
ghost.init({
	clientId: "ghost-frontend",
	clientSecret: "ffd2c8ae15fe"
});
</script>
    <meta name="generator" content="Ghost 2.2">
    <link rel="alternate" type="application/rss+xml" title="Chris Arderne" href="/rss/">
	</head>
	<body class="post-template tag-inside">
		<header id="header">
			<a id="logo" href="https://rdrn.me"><img src="../content/images/2018/10/face3.png" alt="Chris Arderne"></a>
			<h1><a href="https://rdrn.me">Chris Arderne</a></h1>
                        
			<div id="icons">
<a href="mailto:chris@rdrn.me"><i class="fa fa-envelope-square"></i></a>
<a href="https://www.linkedin.com/in/chris-arderne" target="_blank"><i class="fa fa-linkedin-square"></i></a>
<a href="https://github.com/carderne" target="_blank"><i class="fa fa-github-square"></i></a>
</div> 
			  <div id="internal_link"><h5><a href="/">Home</a></h5></div>
  <div id="internal_link"><h5><a href="/about/">About me</a></h5></div>

                        <p>A blog for adventurous trip reports, explorations of data and code, and sometimes even things from my day job. Use the links above to learn more, see my work and get in touch.</p>
		</header>
		<main id="content"> 
			<article id="5bc9f471fb49665c9058d756" class="post tag-inside">
	<div class="post-stamp">19 October 2018<span class="taglist"> · <a href="../tag/inside/">Inside</a></span></div>
	<h1 class="post-title">Leaflet maps with data from Google Sheets</h1>
	<p><em>I wrote another post <a href="/python-mapping-automatic-updating/">here</a>, outlining how this can be achieved without stepping out of a Python environment.</em></p><p>I love working with Python, but as soon as you want to put something online, JavaScript's ability to process in the browser is a clear winner. For one, you can have statically served HTML files performing complex tasks, whereas with Python you'd need a cloud instance running and a system for communicating between front- and back-end.</p><p>In this post I'm going to go through making a web map in JavaScript that pulls data from Google Sheets – where non-coders can easily make updates. This seems to be a common request and something that is not well covered by the various GUI solutions available. There is a <a href="https://www.datavizforall.org/leaflet/with-google-sheets/">Data Visualization for All</a> guide, but it didn't seem to work well (potentially due to changes in Google's API) and is overly complex.</p><p><em>Skip the first two sections if you just want the juicy stuff, or go straight to the <a href="https://github.com/carderne/leaflet-gsheets">repo</a>.</em></p><h3 id="client-side-programming">Client-side programming</h3><p>JavaScript is unique in being used on both the client- and server-sides of a web application. This means it can run directly in a user's browser without anything happening on the server, but can also be used on the back-end (via <a href="https://nodejs.org/">Node.js</a>) for moving data around and doing the heavy lifting. For this example, I'm basically taking advantage of the user's computer to do the processing, so that I don't have to pay <a href="https://aws.amazon.com/">Amazon</a>/<a href="https://aws.amazon.com/">Google</a>/<a href="https://azure.microsoft.com/">Microsoft</a> to do it for me on a cloud instance. This dual nature of JavaScript is one of the reasons for its booming popularity in web development.</p><h3 id="mapping-libraries-available-in-javascript">Mapping libraries available in JavaScript</h3><p>Another reason for JavaScript's ubiquity is the endless variety of libraries available, and the ease with which these can be used, thanks, in part, to <a href="https://blog.codinghorror.com/the-principle-of-least-power/">Atwood's Law</a>:</p><blockquote>any application that <em>can</em> be written in JavaScript, <em>will</em> eventually be written in JavaScript</blockquote><p>As for web mapping, there are a few obvious choices:</p><ul><li><a href="https://openlayers.org/">OpenLayers</a> – the most mature and powerful option, but also heavy and quite complex to use</li><li><a href="https://developers.google.com/maps/documentation/javascript/tutorial">Google Maps JavaScript API</a> – limited basemap options and it's closed source (noting the irony that this post is all about Google Sheets)</li><li><a href="https://www.mapbox.com/mapbox-gl-js/api/">Mapbox GL JS</a> (or the older <a href="https://www.mapbox.com/help/define-mapbox-js/">Mapbox.js</a>) – great for integrating with <a href="https://www.mapbox.com/mapbox-studio/">Mapbox Studio</a> (designing basemaps) and their <a href="https://www.mapbox.com/geocoding/">geocoding</a> service</li><li><a href="https://leafletjs.com/">Leaflet</a> – light-weight, well-documented and easy to use for simple projects – goldilocks!</li></ul><p>You can read a more complete overview <a href="https://ledeprogram.com/2015/absolutely-everything-you-need-to-know-about-mapping-tools/">here</a>; it's a bit out of date, but includes comparisons with non JavaScript solutions such as <a href="https://carto.com/">Carto</a> (not cheap, unfortunately). </p><h3 id="pulling-data-from-google-sheets">Pulling data from Google Sheets</h3><p><em>In all the code excerpts, I'm stripping it to the bare essentials for readability. The full code is available at the <a href="https://github.com/carderne/leaflet-gsheets">repo</a>.</em></p><p>To make maps from Google Sheets, we first need to get data <em>from </em>Google Sheets. This is made exceedingly easy by <a href="https://github.com/jsoma/tabletop">Tabletop.js</a>, a simple library for pulling in entire sheets as JSON objects. This is done in a few lines of code:</p><pre><code class="language-JavaScript">function init() {
    Tabletop.init({
        key: sheetsUrl,
        callback: myFunction,
        simpleSheet: true
    })
}

window.addEventListener('DOMContentLoaded', init)

function myFunction(data, tabletop) {
    console.log(data);
}
</code></pre>
<p>You just need to get the public sharing link from your Sheet (follow the instructions at the Tabletop.js repo) and assign it to <code>sheetsUrl</code> and you're done! </p><p>The data I pulled in for this web map was two separate tables, which you can preview <a href="https://docs.google.com/spreadsheets/d/1WyZNokrgj5NmbyYrRIOQDa2mZ0_SEdbjBohR2RmKXp8/edit?usp=sharing">here</a> and <a href="https://docs.google.com/spreadsheets/d/1p9pdXDgaLLVFj1agny5m1Y5gHSeRYJP-K0hrENLkfJo/edit?usp=sharing">here</a>. The first has simple <code>lat</code> and <code>long</code> coordinates for a few points, while the second has a more complicated <code>geometry</code> column with polygon representations of each US state. In addition they each have extra columns with more information.</p><h3 id="putting-it-together-for-an-easy-web-map">Putting it together for an easy web map</h3><p>My objective for this web map was to show these point and polygon items on a map of the US, with pop-ups for each element showing additional information. With a few more steps, it's easy to style each element based on other columns in the data.</p><p>Firstly, let's create a basic HTML file to hold our map. The example below provides the bare minimum of importing Tabletop.js, Leaflet.js and the Leaflet CSS styling. It then creates a <code>div</code> with <code>id="map"</code>, which is where our map will go, and then imports <code>leaflet-example.js</code>, which is where our new JavaScript code goes.</p><pre><code class="language-HTML">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;script src='https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.5.1/tabletop.min.js'&gt;&lt;/script&gt;
    &lt;link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"/&gt;
    &lt;script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div id="map"&gt;&lt;/div&gt;
    &lt;script type="text/javascript" src="leaflet-example.js"&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>With that set up, let's create a Leaflet map and insert it into our <code>div</code>, and add a beautiful basemap (basically a background map). A number of basemap options are demoed <a href="https://leaflet-extras.github.io/leaflet-providers/preview/">here</a> – just copy the provided URL into <code>baseMapURL</code> in the code below (and add the suggested attributions).</p><pre><code class="language-JavaScript">var map = L.map('map-div').setView([startLat, startLong], startZoom);
var basemap = L.tileLayer(baseMapURL, {
	attribution: attributionText
});
basemap.addTo(map);
</code></pre>
<p>Next we need to add things to the map! The points are easier, and we can add them by simply looping through each item in the JSON and adding a Leaflet <code>marker</code>. This function is called by the <code>init()</code> function from further up, once the data has been retrieved from Google Sheets.</p><pre><code class="language-JavaScript">function addPoints(data, tabletop) {
    for (var row in data) {
    	var marker = L.marker([
            data[row].lat,
            data[row].long
        ]).addTo(map);
      	marker.bindPopup(data[row].category);
    }
}
</code></pre>
<p>The polygons are slightly more complicated, as Leaflet needs a <a href="https://macwright.org/2015/03/23/geojson-second-bite.html#featurecollection">GeoJSON</a> object to represent them. So in a new function like the previous one (also called by the <code>init()</code> function), we have the following code to create a single GeoJSON containing all of our polygons.</p><pre><code class="language-JavaScript">function addPolygons(data, tabletop) {
    // the empty GeoJSON waiting to be populated with features
    var polygons = {
        "type": "FeatureCollection",
        "features": []
    }

    for (var row in data) {
        // JSON.parse converts the geometry strings into JSON objects
        var coords = JSON.parse(data[row].geometry);

        polygons.features.push({
            "type": "Feature",
            "geometry": {
                "type": "MultiPolygon",
                "coordinates": coords
            },
            "properties": {
                "name": data[row].name,
            }
        });
    }
}
</code></pre>
<p>This sets up an empty GeoJSON and then loops through each element in <code>data</code> and inserts the coordinates and names as <code>Feature</code> elements within the GeoJSON. With this set up, it's just a few lines to add this new object to our Leaflet map. The lines below can be added at the bottom of the <code>addPolygon</code> function for simplicity.</p><pre><code class="language-JavaScript">polygonMarkers = L.geoJSON(polygons, {
    onEachFeature: function (feature, layer) {
        layer.bindPopup(feature.properties.name);
    },
}).addTo(map);
</code></pre>
<p>As for the points further up, this includes the code to add a popup, but nothing on styling. That's probably a post for another day, but you can have a look at the <a href="https://github.com/carderne/leaflet-gsheets">repo</a> if you want to see what I used for this example.</p><p>And we're done! The result (with styling) is shown below, or click <a href="/leaflet-gsheets/leaflet-gsheets.html">here</a> to see it full screen. Every time a user loads this map in their browser, it will automatically hop over to the specified Google Sheets and pull the latest data to display it.</p><iframe src="/leaflet-maps-google-sheets/leaflet-gsheets-nosidebar.html" style="width: 100%; height: 600px" name="internal" frameborder="0"></iframe>
</article>  

		</main>
		<footer id="footer">
			<section id="footer-message">© 2018 Chris Arderne.</section>
		</footer>
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
	</body>
</html>