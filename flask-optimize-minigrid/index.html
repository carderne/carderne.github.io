<!DOCTYPE html>
<html>
	<head>
            <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
	    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
	    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	    <title>A Flask app for mini-grid planning with a cost-optimised spanning tree</title>
	    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,700italic,300,700" rel="stylesheet" type="text/css">
			<link href="https://fonts.googleapis.com/css?family=Bree+Serif" rel="stylesheet" type="text/css">
			<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/github.min.css">
			<link rel="stylesheet" type="text/css" href="../assets/styles/crisp.css?v=0157ccc34f">
	    <meta name="HandheldFriendly" content="True">
	    <meta name="viewport" content="width=device-width, initial-scale=1.0">
			<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
			<!--[if lt IE 9]>
				<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
				<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
			<![endif]-->
			
	    <meta name="description" content="We've mapped over 4 million buildings in Tanzania. This post explores the possibilities of this data for off-grid planning using a simple Flask web app.">
    <link rel="shortcut icon" href="../favicon.png" type="image/png">
    <link rel="canonical" href="/flask-optimize-minigrid/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta property="og:site_name" content="Chris Arderne">
    <meta property="og:type" content="article">
    <meta property="og:title" content="A Flask app for mini-grid planning with a cost-optimised spanning tree">
    <meta property="og:description" content="We've mapped over 4 million buildings in Tanzania. This post explores the possibilities of this data for off-grid planning using a simple Flask web app.">
    <meta property="og:url" content="/flask-optimize-minigrid/">
    <meta property="article:published_time" content="2018-03-18T13:20:00.000Z">
    <meta property="article:modified_time" content="2018-11-04T15:28:13.000Z">
    <meta property="article:tag" content="Inside">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="A Flask app for mini-grid planning with a cost-optimised spanning tree">
    <meta name="twitter:description" content="We've mapped over 4 million buildings in Tanzania. This post explores the possibilities of this data for off-grid planning using a simple Flask web app.">
    <meta name="twitter:url" content="/flask-optimize-minigrid/">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="Chris Arderne">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="Inside">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Chris Arderne",
        "logo": {
            "@type": "ImageObject",
            "url": "/content/images/2018/10/face3.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Chris Arderne",
        "url": "/author/chris/",
        "sameAs": []
    },
    "headline": "A Flask app for mini-grid planning with a cost-optimised spanning tree",
    "url": "/flask-optimize-minigrid/",
    "datePublished": "2018-03-18T13:20:00.000Z",
    "dateModified": "2018-11-04T15:28:13.000Z",
    "keywords": "Inside",
    "description": "We&#x27;ve mapped over 4 million buildings in Tanzania. This post explores the possibilities of this data for off-grid planning using a simple Flask web app.",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "/"
    }
}
    </script>

    <script src="../public/ghost-sdk.min.js?v=0157ccc34f"></script>
<script>
ghost.init({
	clientId: "ghost-frontend",
	clientSecret: "ffd2c8ae15fe"
});
</script>
    <meta name="generator" content="Ghost 2.2">
    <link rel="alternate" type="application/rss+xml" title="Chris Arderne" href="/rss/">
	</head>
	<body class="post-template tag-inside">
		<header id="header">
			<a id="logo" href="https://rdrn.me"><img src="../content/images/2018/10/face3.png" alt="Chris Arderne"></a>
			<h1><a href="https://rdrn.me">Chris Arderne</a></h1>
                        
			<div id="icons">
<a href="mailto:chris@rdrn.me"><i class="fa fa-envelope-square"></i></a>
<a href="https://www.linkedin.com/in/chris-arderne" target="_blank"><i class="fa fa-linkedin-square"></i></a>
<a href="https://github.com/carderne" target="_blank"><i class="fa fa-github-square"></i></a>
</div> 
			  <div id="internal_link"><h5><a href="/">Home</a></h5></div>
  <div id="internal_link"><h5><a href="/about/">About me</a></h5></div>

                        <p>A blog for adventurous trip reports, explorations of data and code, and sometimes even things from my day job. Use the links above to learn more, see my work and get in touch.</p>
		</header>
		<main id="content"> 
			<article id="5bbc65427cc70a140e7fd122" class="post tag-inside">
	<div class="post-stamp">18 March 2018<span class="taglist"> · <a href="../tag/inside/">Inside</a></span></div>
	<h1 class="post-title">A Flask app for mini-grid planning with a cost-optimised spanning tree</h1>
	<p>As part of ongoing work on energy access in Tanzania, we (the <a href="https://www.ifc.org">IFC</a>, together with Tanzania's Rural Energy Agency) have mapped over 4 million buildings in rural parts of the country. This gives loads of new possibilities to those looking to work in these areas, and not only in the energy sector. One of these is the ability to conduct detailed site assessments, including sensible estimates of household populations and potential demand, along with wiring requirements to connect a village.</p><p>Apart from  the potential for use in state planning for new grid extensions, this data is valuable to private developers looking to sell off-grid services such as stand-alone solar systems (such as those sold by <a href="https://www.bloomberg.com/features/2015-mkopa-solar-in-africa/">M-Kopa</a>) as well as more capital intensive mini-grid systems (with a power source and grid connecting households, but no connection to the national grid), which <a href="https://www.greentechmedia.com/articles/read/minigrids-are-the-cheapest-way-to-electrify-100-million-africans-today">some suggest</a> are a key to tackling energy access issues.</p><p>In this post I'm focusing on mini-grids, mostly because it's a more interesting problem to analyse. However, I also provide some cost comparisons with national grid connections. This post is split into two main sections:</p><ol><li>Using a minimum spanning tree and cost-optimisation algorithm to find the ideal network layout for a given village and parameters</li><li>Serving this as a GIS web app with Flask, where users can customise inputs, run the model, and visualise results</li></ol><p>So if you just want an example of a basic Flask app, go ahead and skip to the second section. Or just check out the <a href="https://github.com/carderne/minigrid-optimiser">GitHub repo</a> for the code for both sections.</p><h2 id="1-optimising-mini-grids-in-rural-villages">1. Optimising mini-grids in rural villages</h2><p>As I've covered <a href="/open-data-access-tanzania/">elsewhere</a>, data is one of the key barriers to ramping up off-grid development and investment. Machine learning and ML-supported manual mapping in OpenStreetMap (a strategy we applied in Tanzania) are starting to make inroads into this problem, at least for assessing demand.</p><p>As a test case, I've chosen the village of <a href="https://www.openstreetmap.org/search?query=Tanzania#map=15/-5.0719/32.2804">Sipungu</a> in the Tabora region of Tanzania. To start off with, let's see how this village looks in OpenStreetMap compared to Google Maps. Each of the 444 little shapes on the left is a building, accurately traced by the <a href="https://www.hotosm.org/where-we-work/tanzania/">HOT</a> team in Dar es Salaam as part of the IFC project. Some are homes, some are stores, some are schools. As you can see, there's no information in Google Maps about this village – not even the road in.</p><figure class="kg-card kg-image-card"><img src="../content/images/2018/11/sipungu_compare_maps2.png" class="kg-image"></figure><p>To find the optimum way of connecting all these buildings to a mini-grid system, we turn to network theory, and in particular, the <a href="https://en.wikipedia.org/wiki/Minimum_spanning_tree">minimum spanning tree</a>. This is the set of lines that connects a group of points with the minimum total distance (or other cost function). For the village of Sipungu, this looks as follows, where each blue dot is a building (very small ones filtered) and the green point a randomly chosen location for the solar PV installation. Interestingly, the easiest way to calculate this spanning tree was the incredible <a href="https://www.astroml.org/">astroML</a> library – built for astronomy more than rural villages.</p><figure class="kg-card kg-image-card"><img src="../content/images/2018/11/mst-1.png" class="kg-image"></figure><p>Our goal then is to determine, based on some criteria, which of these connections to maintain. The first step is to <em>direct </em>the network from the PV installation outwards, so that the model knows where to start in looking for connections to drop or keep. We don't want to accidentally disconnect the PV system itself! This is a process not dissimilar to the stream ordering used in my <a href="/modelling-hydrological-networks/">hydrological modelling</a>. Conceptually they fall in with a broad range of physical, mathematical and <a href="/visualizing-book-club-ai/">social</a> problems<a href="https://en.wikipedia.org/wiki/Network_theory"> </a>where network theory is applied.</p><p>There are a number of different ways to cost-optimise this network; I chose a brute force approach to find the configuration with the highest <a href="https://en.wikipedia.org/wiki/Net_present_value">net present value</a>, i.e. the most money for the developer, taking into account the future income streams and costs. This sounds like a ruthless way of thinking, but for more mini-grids to get built and more people to get access to electricity, they need to be sustainable. The hope is that once the system is running, demand will increase and more households will become profitable to connect.</p><p>The algorithm starts with the complete network, and considers which single <em>deletion </em>of a line a connecting two households provide the biggest boost to profitability. For example, a very small household far away from any others - lots of wire, but not much demand or electricity sold. It then repeats this process over and over again until there are no more profitable configurations to be found and that is the optimum network!</p><p>I contrived the following main parameters for the village of Sipungu, along with some heuristics for determining the number of people based on building size.</p><ul><li>Minimum building size: 30 m<sup>2</sup></li><li>Wire cost: 25 USD/m</li><li>Connection cost: 150 USD/household</li><li>Tariff: 0.25 USD/kWh</li><li>Demand: 6 kWh/person/month</li><li>Generator cost: 7,000 USD/kW</li></ul><p>The resultant optimised network is shown below, where about 80% of the buildings are connected by the algorithm. The remaining little clusters are deemed to not be worth connecting, based on the capital outlay required and expected returns based on the demand and tariff above. So with this new data and this model, we already have an estimate of the costs involved and how the mini-grid might end up looking (noting, of course that the real network will follow real-world constraints like the existing road).</p><iframe src="/flask-optimize-minigrid/map-sipungu.html" style="width: 100%; height: 400px" name="internal" frameborder="0"></iframe><p>Note that I mentioned the model optimises for NPV. With these parameters, the NPV of this development was calculated to be USD -815,000 – in the optimum case! So either the developer needs to cut costs, or charge higher tariffs, or hope for higher demand. This leads me to another extremely useful feature of this type of model: easy scaling. It's as easy to model Sipungu village as it is to model hundreds of villages.</p><p>So I did. To explore the relationship between village density and economics, and to understand tariffs needed for project profitability, I modelled 100 Tanzanian villages, considering for each one different combinations of costs, demand and village coverage (percentage of households electrified). In the chart below, each point represents a model run, with demand on the horizontal axis (6 kWh, from the example above, is marked by a vertical red line) and the required tariff for a 6-year payback on the vertical.</p><p>As you can see, there are not many villages that can sustain a mini-grid at that demand level and tariff. Even at extremely high demand levels, around 0.24 USD/kWh is still needed for projects to be feasible. However, grid electricity in Tanzania is below 0.10 USD/kWh, so this is unlikely to be possible for poor rural villages. One possible solution: subsidies.</p><figure class="kg-card kg-image-card"><img src="../content/images/2018/11/payback_big_density_mark6-2.png" class="kg-image"></figure><h2 id="2-creating-a-simple-gis-web-app-with-flask">2. Creating a simple GIS web app with Flask</h2><p>A web app interface to the model would make it a lot more accessibly to non-coders. So I set out to create a basic app that would allow a user to select a village and the desired input parameters, and get an interactive map and summary results in-browser. Even better (but for another day) might be to create a simple API that accepts the parameters and returns the necessary data for visualization and results. </p><p><a href="https://github.com/pallets/flask">Flask</a> is a Python web framework – it transforms data and code into web pages and APIs. I selected it for this project because it is lightweight and easy. A basic Flask app looks as follows. The <code>'/'</code> in <code>@app.route()</code> tells Flask that this method should be run when someone accesses the base URL of the website, and the <code>'Hello World!'</code> returned is what will be displayed in the user's browser.</p><pre><code class="language-python">from flask import Flask
app = Flask(__name__)

@app.route('/')
def hello():
    return 'Hello World!'
</code></pre>
<p>Most of the time you want your result to look better than that, so you use an HTML template, into which Flask inserts results as follows using the module <code>render_template</code>. I set up a template with buttons and selectors for the model parameters, and a big window where the mapped results can be displayed. When the user first arrives, they are greeted with an overview map of Tanzania and a selector list on the left. Once they've chosen a village, selected the generator site, and inserts the other parameters, they are shown the mapped results – as in the example below for Uwemba.</p><figure class="kg-card kg-image-card"><img src="../content/images/2018/11/app_scr-1.png" class="kg-image"></figure><p>As in the code snippet above, this is all handled using a single main function. Different <code>GET</code> and <code>POST</code> values, depending on the user's selections and clicks, guide the function to return what's needed.</p><p>However, there's one big problem. If two users try to use the website, they'll end up fighting over the same background instance of the model and may overwrite each other's data. I handled this using the Flask <code>session</code> module and <a href="https://github.com/bbangert/beaker">beaker</a> middleware for handling the cached user files. Then there's only one thing left to do: push it to a server where it can run without keeping my laptop hot. I used a simple git set up to push the latest model and app to a Google cloud instance, and use <code>supervisor</code> to keep the Flask app up and running. I won't post all of the code here, but it's available at my <a href="https://github.com/carderne/minigrid-optimiser">GitHub repo</a>.</p>
</article>  

		</main>
		<footer id="footer">
			<section id="footer-message">© 2018 Chris Arderne.</section>
		</footer>
	
	
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
	</body>
</html>