<!DOCTYPE html>
<html>
	<head>
            <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
	    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
	    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	    <title>A workflow for Python mapping with automatic updating</title>
	    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,700italic,300,700" rel="stylesheet" type="text/css">
			<link href="https://fonts.googleapis.com/css?family=Bree+Serif" rel="stylesheet" type="text/css">

			<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
			<link rel="stylesheet" type="text/css" href="../assets/styles/crisp.css?v=8110b7ec51">
	    <meta name="HandheldFriendly" content="True">
	    <meta name="viewport" content="width=device-width, initial-scale=1.0">
			<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
			<!--[if lt IE 9]>
				<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
				<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
			<![endif]-->
			
	    <meta name="description" content="A friend needed a map of the US displayed with points at specific locations with attached information, and overviews for certain states with summaries.">
    <link rel="shortcut icon" href="../favicon.png" type="image/png">
    <link rel="canonical" href="/python-mapping-automatic-updating/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta property="og:site_name" content="Chris Arderne">
    <meta property="og:type" content="article">
    <meta property="og:title" content="A workflow for Python mapping with automatic updating">
    <meta property="og:description" content="A friend needed a map of the US displayed with points at specific locations with attached information, and overviews for certain states with summaries. And for this to be done (and updated) as easily as possible by people with no coding knowledge.">
    <meta property="og:url" content="/python-mapping-automatic-updating/">
    <meta property="article:published_time" content="2018-06-20T06:47:00.000Z">
    <meta property="article:modified_time" content="2018-10-21T09:47:53.000Z">
    <meta property="article:tag" content="Inside">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="A workflow for Python mapping with automatic updating">
    <meta name="twitter:description" content="A friend needed a map of the US displayed with points at specific locations with attached information, and overviews for certain states with summaries. And for this to be done (and updated) as easily as possible by people with no coding knowledge.">
    <meta name="twitter:url" content="/python-mapping-automatic-updating/">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="Chris Arderne">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="Inside">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Chris Arderne",
        "logo": {
            "@type": "ImageObject",
            "url": "/content/images/2018/10/face3.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Chris Arderne",
        "url": "/author/chris/",
        "sameAs": []
    },
    "headline": "A workflow for Python mapping with automatic updating",
    "url": "/python-mapping-automatic-updating/",
    "datePublished": "2018-06-20T06:47:00.000Z",
    "dateModified": "2018-10-21T09:47:53.000Z",
    "keywords": "Inside",
    "description": "A friend needed a map of the US displayed with points at specific locations with attached information, and overviews for certain states with summaries. And for this to be done (and updated) as easily as possible by people with no coding knowledge.",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "/"
    }
}
    </script>

    <script src="../public/ghost-sdk.min.js?v=8110b7ec51"></script>
<script>
ghost.init({
	clientId: "ghost-frontend",
	clientSecret: "ffd2c8ae15fe"
});
</script>
    <meta name="generator" content="Ghost 2.2">
    <link rel="alternate" type="application/rss+xml" title="Chris Arderne" href="/rss/">
	</head>
	<body class="post-template tag-inside">
		<header id="header">
			<a id="logo" href="https://rdrn.me"><img src="../content/images/2018/10/face3.png" alt="Chris Arderne"></a>
			<h1><a href="https://rdrn.me">Chris Arderne</a></h1>
                        
			<div id="icons">
<a href="mailto:chris@rdrn.me"><i class="fa fa-envelope-square"></i></a>
<a href="https://www.linkedin.com/in/chris-arderne" target="_blank"><i class="fa fa-linkedin-square"></i></a>
<a href="https://github.com/carderne" target="_blank"><i class="fa fa-github-square"></i></a>
</div> 
			  <div id="internal_link"><h5><a href="/">Home</a></h5></div>
  <div id="internal_link"><h5><a href="/about/">About me</a></h5></div>

                        <p>I use code and GIS in my work related to energy and finance. Apart from that, I like mountains and the sea. Click the links above to learn more, see my work and get in touch.</p>
		</header>
		<main id="content"> 
			<article id="5bc2ec443e94a80ccd4f5547" class="post tag-inside">
	<div class="post-stamp">20 June 2018<span class="taglist"> · <a href="../tag/inside/">Inside</a></span></div>
	<h1 class="post-title">A workflow for Python mapping with automatic updating</h1>
	<p><em>This is intended as a workflow for a Python application focused on modelling and mapping. For a much simpler solution to produce dynamic maps from Google Sheets data using JavaScript, see my other post <a href="/leaflet-maps-google-sheets/">here</a>.</em></p><p>A friend needed a map of the US displayed with points at specific locations with attached information, and overviews for certain states with summaries. And for this to be done (and updated) as easily as possible by people with no coding knowledge. Their solution was <a href="https://www.google.com/mymaps">Google My Maps</a>, which was probably more than adequate for what they're trying to achieve.</p><p>So (mostly for the fun of it) I decided to see if I could help out, using Folium and some simple tables. My first proposal ("just run this Jupyter notebook and embed the output") didn't go over well. So I decided to explore how to make it as simple as possible, and this is what I came up with.</p><div style="text-align:center;"><svg xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink" width="499px" version="1.1" viewbox="0 0 499 252" style="max-width:100%;max-height:252px;"><defs></defs><g transform="translate(0.5,0.5)"><a xlink:href="https://developers.google.com/apis-explorer/"><path d="M 70 31 L 184.03 31" fill="none" stroke="#d79b00" stroke-miterlimit="10"></path><path d="M 189.28 31 L 182.28 34.5 L 184.03 31 L 182.28 27.5 Z" fill="#d79b00" stroke="#d79b00" stroke-miterlimit="10"></path><g transform="translate(84.5,15.5)"><switch><foreignobject style="overflow:visible;" pointer-events="all" width="70" height="11" requiredfeatures="https://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="https://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Verdana; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="https://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">Google APIs</div></div></foreignobject><text x="35" y="11" fill="#000000" text-anchor="middle" font-size="11px" font-family="Verdana">Google APIs</text></switch></g></a><a xlink:href="https://www.google.com/sheets/about/"><rect x="0" y="11" width="70" height="40" fill="#ffe6cc" stroke="#d79b00"></rect><g transform="translate(1.5,18.5)"><switch><foreignobject style="overflow:visible;" pointer-events="all" width="66" height="24" requiredfeatures="https://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="https://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Verdana; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 66px; white-space: normal; overflow-wrap: normal; text-align: center;"><div xmlns="https://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">Google Sheets</div></div></foreignobject><text x="33" y="18" fill="#000000" text-anchor="middle" font-size="11px" font-family="Verdana">Google Sheets</text></switch></g></a><a xlink:href="https://geopandas.org/"><path d="M 225 51 L 225 144.63" fill="none" stroke="#6c8ebf" stroke-miterlimit="10"></path><path d="M 225 149.88 L 221.5 142.88 L 225 144.63 L 228.5 142.88 Z" fill="#6c8ebf" stroke="#6c8ebf" stroke-miterlimit="10"></path><g transform="translate(178.5,89.5)rotate(-90,31,5.5)"><switch><foreignobject style="overflow:visible;" pointer-events="all" width="62" height="11" requiredfeatures="https://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="https://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Verdana; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="https://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">geopandas</div></div></foreignobject><text x="31" y="11" fill="#000000" text-anchor="middle" font-size="11px" font-family="Verdana">geopandas</text></switch></g></a><a xlink:href="https://github.com/burnash/gspread"><rect x="190" y="11" width="70" height="40" fill="#dae8fc" stroke="#6c8ebf"></rect><g transform="translate(201.5,25.5)"><switch><foreignobject style="overflow:visible;" pointer-events="all" width="46" height="11" requiredfeatures="https://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="https://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Verdana; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 47px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="https://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">gspread</div></div></foreignobject><text x="23" y="11" fill="#000000" text-anchor="middle" font-size="11px" font-family="Verdana">gspread</text></switch></g></a><path d="M 260 171 L 343.63 171" fill="none" stroke="#6c8ebf" stroke-miterlimit="10"></path><path d="M 348.88 171 L 341.88 174.5 L 343.63 171 L 341.88 167.5 Z" fill="#6c8ebf" stroke="#6c8ebf" stroke-miterlimit="10"></path><g transform="translate(281.5,155.5)"><switch><foreignobject style="overflow:visible;" pointer-events="all" width="45" height="11" requiredfeatures="https://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="https://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Verdana; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="https://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;"><div style="font-size: 11px">git push</div></div></div></foreignobject><text x="23" y="11" fill="#000000" text-anchor="middle" font-size="11px" font-family="Verdana">[Not supported by viewer]</text></switch></g><a xlink:href="https://github.com/python-visualization/folium"><rect x="190" y="151" width="70" height="40" fill="#dae8fc" stroke="#6c8ebf"></rect><g transform="translate(206.5,165.5)"><switch><foreignobject style="overflow:visible;" pointer-events="all" width="37" height="11" requiredfeatures="https://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="https://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Verdana; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 38px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="https://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">Folium</div></div></foreignobject><text x="19" y="11" fill="#000000" text-anchor="middle" font-size="11px" font-family="Verdana">Folium</text></switch></g></a><path d="M 420 171 L 483.63 171" fill="none" stroke="#82b366" stroke-miterlimit="10" stroke-dasharray="3 3"></path><path d="M 488.88 171 L 481.88 174.5 L 483.63 171 L 481.88 167.5 Z" fill="#82b366" stroke="#82b366" stroke-miterlimit="10"></path><g transform="translate(427.5,155.5)"><switch><foreignobject style="overflow:visible;" pointer-events="all" width="54" height="11" requiredfeatures="https://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="https://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Verdana; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="https://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;"><div style="font-size: 11px">map.html</div></div></div></foreignobject><text x="27" y="11" fill="#000000" text-anchor="middle" font-size="11px" font-family="Verdana">[Not supported by viewer]</text></switch></g><a xlink:href="https://github.com/carderne/environmental-mapping"><rect x="350" y="151" width="70" height="40" fill="#d5e8d4" stroke="#82b366"></rect><g transform="translate(365.5,165.5)"><switch><foreignobject style="overflow:visible;" pointer-events="all" width="38" height="11" requiredfeatures="https://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="https://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Verdana; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 39px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="https://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><div style="font-size: 11px">GitHub</div></div></div></foreignobject><text x="19" y="11" fill="#000000" text-anchor="middle" font-size="11px" font-family="Verdana">[Not supported by viewer]</text></switch></g></a><rect x="180" y="1" width="90" height="250" fill="none" stroke="#7ea6e0" stroke-width="2" stroke-dasharray="6 6"></rect><a xlink:href="https://cloud.google.com/compute/"><rect x="180" y="201" width="90" height="50" fill="none" stroke="none"></rect><g transform="translate(180.5,206.5)"><switch><foreignobject style="overflow:visible;" pointer-events="all" width="88" height="38" requiredfeatures="https://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="https://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Verdana; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 88px; white-space: normal; overflow-wrap: normal; text-align: center;"><div xmlns="https://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">Google Compute Engine</div></div></foreignobject><text x="44" y="25" fill="#000000" text-anchor="middle" font-size="11px" font-family="Verdana">Google Compute Engine</text></switch></g></a></g></svg></div><p>Firstly there are two Google Sheets with a simple format. The first (example .csv <a href="https://github.com/carderne/web-mapping/blob/master/data-sources/US-environmental-laws.csv">here</a>) contains specific point data with coordinates in decimal degrees.</p><figure class="kg-card kg-image-card"><img src="../content/images/2018/10/1.png" class="kg-image"></figure><p>And the second (example .csv <a href="https://github.com/carderne/web-mapping/blob/master/data-sources/US-states-folium.csv">here</a>) contains summary state-level data with polygon representations of each state. These are shared with anyone who might need access to updating the map data.</p><figure class="kg-card kg-image-card"><img src="../content/images/2018/10/3-1.png" class="kg-image"></figure><p>Then the Python package <a href="https://github.com/burnash/gspread">gspread</a> makes it extremely easy to pull this data using OAuth2. It has great instructions on how to set up a Google API key and access specific sheets. It's only a few lines of code to pull the data and convert into a <a href="https://pandas.pydata.org/">pandas</a> DataFrame.</p><pre><code class="language-python">import pandas as pd
import gspread
from oauth2client.service_account import ServiceAccountCredentials

scope = ['https://spreadsheets.google.com/feeds',
         'https://www.googleapis.com/auth/drive']
credentials = ServiceAccountCredentials.from_json_keyfile_name(
    'google-api-key.json', scope)
gc = gspread.authorize(credentials)

wks = gc.open("sheet").sheet1  # sheet is the name of the Google Sheet
wks_vals = wks.get_all_values()
df = pd.DataFrame(wks_vals[1:], columns=wks_vals[0])
</code></pre>
<p>And then a few more to convert this into a <a href="https://geopandas.org/">GeoPandas</a> GeoDataFrame, which extends pandas with a <em>geometry</em> attribute and provides easy access to the geospatial packages <a href="https://toblerity.org/shapely/">Shapely</a> and <a href="https://toblerity.org/fiona/">Fiona</a>. More importantly, they play nicely with Folium, my preferred shortcut to easy JavaScript web-maps.</p><pre><code class="language-python">import geopandas as gpd
from shapely.geometry import Point

df = df.astype({'X': int, 'Y':int})
geo = [Point(xy) for xy in zip(laws['Y'], laws['X'])]
gdf = gpd.GeoDataFrame(df, crs={'init':'epsg:4326'}, geometry=geo)
</code></pre>
<p>With a similar process for the other Sheet, it is a simple process to create a basic map based on this GeoDataFrame. Please have a look at my repo <a href="https://github.com/carderne/web-mapping/tree/master/folium-gspread">here</a> for the complete code and output.</p><pre><code class="language-python">import folium

m = folium.Map([40, -100], zoom_start=5)
c = folium.GeoJson(gdf)     
c.add_to(m)  

# m
# m.save('map.html')
</code></pre>
<p>The final step is to make this all happen in a predictable way that doesn't force anyone to get their hands covered in code, who doesn't particularly want to. So we set this code up on a Google Compute instance and have it output the results as an embeddable html file. To avoid dealing with servers and firewalls, I cloned into a new <a href="https://github.com/carderne/web-mapping/tree/master/folium-gspread">GitHub repo</a> and set up a cron-job to run the following script every hour.</p><p>cron entry:</p>
<pre><code class="language-bash">0 * * * * /home/username/update_map.sh
</code></pre>
<p>update_map.sh:</p>
<pre><code class="language-bash">python enviro_map.py
git add .
git commit -m "Hourly map update"
git pull --no-edit
git push
</code></pre>
<p>This pushes the updated html file to the repo, where my so-called clients can easily <a href="https://github.com/carderne/leaflet-gsheets">access it</a> to embed in their website. Then all they have to do to update their website is edit the Google Sheets and wait for the new results to appear embedded in their website.</p><iframe src="/leaflet-gsheets/leaflet-gsheets.html" style="width: 100%; height: 600px" name="internal" frameborder="0"></iframe>
</article>  

		</main>
		<footer id="footer">
			<section id="footer-message">© 2018 Chris Arderne.</section>
		</footer>
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
	</body>
</html>